name: CI â€” Lint and Render Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libharfbuzz-dev libfribidi-dev libicu-dev

      - name: Install R packages
        run: |
          Rscript -e 'install.packages(c(
            "yaml", "lintr", "dplyr", "stringi", "lubridate",
            "ggplot2", "tidyr", "stringr", "forcats", "tibble",
            "scales", "patchwork", "ggrepel",
            "knitr", "kableExtra", "rmarkdown",
            "quanteda", "quanteda.textstats", "tidytext"
          ), repos = "https://cloud.r-project.org/")'

      - name: Lint R scripts
        run: |
          Rscript -e '
            library(lintr)
            lints <- lint_dir("R", linters = linters_with_defaults(
              line_length_linter(120),
              object_name_linter = NULL,
              commented_code_linter = NULL
            ))
            print(lints)
            if (length(lints) > 0) {
              cat("Linting issues found (non-blocking).\n")
            }
          '

      - name: Check config.yml is valid YAML
        run: |
          Rscript -e 'yaml::read_yaml("config.yml"); cat("config.yml OK\n")'

      - name: Check helpers load without error
        run: |
          Rscript -e 'source("R/00_helpers.R"); cat("Helpers OK\n")'

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "1.4.553"

      - name: Check Quarto document parses
        run: quarto check R/03_analysis.qmd || true
